(()=>{var m={permanentListeners:[],permanent:"permanent",content:"content",contentListeners:[],addEventListener:function(n,e,t,o){n.addEventListener(e,t),o===m.permanent?m.permanentListeners.push([n,e,t]):m.contentListeners.push([n,e,t])},clearAllListeners:function(){m.permanentListeners.forEach(n=>{n[0].removeEventListener(n[1],n[2])}),m.permanentListeners=[],m.clearContentListeners()},clearContentListeners:function(){m.contentListeners.forEach(n=>{n[0].removeEventListener(n[1],n[2])}),m.contentListeners=[]}},i=m;var g={data:{},name:"Load storage",set:function(n,e){g.data[n]=e,chrome.storage.local.set({[n]:e})},load:async function(){await chrome.storage.local.get(function(n){for(let[e,t]of Object.entries(n))g.data[e]=t})},clear:async function(){g.data={},await chrome.storage.local.clear()}},d=g;var k={name:"Close menu",actionRemove:function(){d.data.exitOnAction===!0&&k.manualRemove()},manualRemove:function(){document.getElementById("menu").remove(),i.clearAllListeners()}},s=k;var b={name:"Settings",addEventListeners:function(n){let e=document.getElementById("addToStudentUrlPath");e.focus(),i.addEventListener(e,"input",function(a){d.set("addToStudentUrlPath",a.target.value)},i.content);let t=document.getElementById("exitOnAction");i.addEventListener(t,"change",function(){d.set("exitOnAction",t.checked)},i.content);let o=document.getElementById("return");i.addEventListener(o,"click",function(a){i.clearContentListeners(),n()},i.content);let r=document.getElementById("reset");i.addEventListener(r,"click",async function(a){await d.clear(),i.clearContentListeners(),b.renderHtml(n)},i.content)},renderHtml:function(n){let e=d.data.addToStudentUrlPath,t=d.data.exitOnAction==!0,o=`
            <div>
            <label>Pathto add after "me/" in link opener</label>
            <input type="text" class="menuItem" id="addToStudentUrlPath" value="${e||"kmom0x/assignment"}" >
            </div>
            <div>
            <label>Automatically exit plugin menu after running a script?</label>
            <input type="checkbox" class="menuItem" id="exitOnAction" ${t?"checked":"undefined"}>
            </div>
            <div style="font-size:14px;">
            Keybinds funkar i startmenyn. F\xF6ljande finns:<br>
            1-X: f\xF6r varje menyval. Trycker du 1 p\xE5 tangetbordet k\xF6rs val 1 osv.<br>
            s: f\xF6r att klicka "Spara" knappen f\xF6r kommentar<br>
            shift+k: v\xE4lj f\xF6reg\xE5ende inl\xE4mning att visa<br>
            shift+j: v\xE4lj n\xE4sta inl\xE4mning att visa<br>
            q: st\xE4nger ner menyn.<br>
            </div>
            <button id="return">Return</button>
            <button id="reset">Reset storage</button>
            `,r=document.getElementById("menuContent");r.innerHTML=o,b.addEventListeners(n)}},p=b;var w=350,L=400,c=document.createElement("div");c.id="menu";c.style.height=`${w}px`;c.style.width=`${L}px`;c.style.position="absolute";c.style.top=window.innerHeight/2-w/2+"px";c.style.left=window.innerWidth/2-L/2+"px";c.style.border="5px solid black";c.style.padding="1em";c.style.backgroundColor="rgba(113, 77, 168, 0.86)";c.style.color="white";c.style.fontSize="24px";var C=document.createElement("div");C.id="menuContent";var f=document.createElement("div");f.style.position="absolute";f.style.right=0;f.style.bottom=0;var y=document.createElement("button");y.id=s.name;y.innerText=s.name;var x=document.createElement("button");x.id=p.name;x.innerText=p.name;f.appendChild(x);f.appendChild(y);c.appendChild(C);c.appendChild(f);var E=c;var j={name:"Open student link",action:function(){let n=d.data.addToStudentUrlPath,e=/(https?:\/\/)?.*student.bth.se\/~\w{4}\d{2}\/dbwebb-kurser\/\w+\//i,o=document.getElementById("speedgrader_iframe").contentWindow.document.getElementById("submission_preview"),r=o.innerText.match(e);if(r!==null){let a=`${r[0].startsWith("http")?"":"https://"}${r[0]}me/${n||""}`;window.open(a,"_blank")}else{let a=/\w{4}\d{2}/i,l=o.innerText.match(a);if(l!==null){let u=`https://www.student.bth.se/~${l}/dbwebb-kurser/`;window.open(u,"_blank")}}s.actionRemove()}},_=j;var P={name:"Open Umbridge link",action:function(){let n=/https:\/\/umbridge\.arnesson\.dev\/results\/inspect\/\d+\/[\w]+/i,e=document.querySelectorAll("div.comment_flex > span");e.length==0&&(e=document.querySelectorAll("[data-testid=submission-comment]"));for(var t=e.length-1;t>=0;t--){let o=e[t].innerHTML.match(n),r=!1;if(o!==null){window.open(o,"_blank");break}}s.actionRemove()}},I=P;var M={name:"Calculate quiz score",action:function(){let n=document.querySelectorAll(".assignment_score"),e=0,t=0;n.forEach(o=>{o.parentElement.querySelectorAll(".tooltip").forEach(a=>{let l=a.innerText.replace(/\s/g,""),u=/(-|\d[\d,]*)\/(\d[\d,]*)/,h=l.match(u);if(h){h[1]==="-"&&(h[1]=0);let R=parseFloat(h[1]),H=parseFloat(h[2]);e+=R,t+=H}})}),alert(`Po\xE4ng: ${e} / ${t}
Score: ${Math.ceil(e/(t/2)*10)/10/2}`),s.actionRemove()}},S=M;function O(n){let e=document.createElement("div");e.style="width:600px;height:800px;overflow:scroll;position:absolute;top:50px;left:20px;background-color:#2C3539;color:#fff;padding:10px;";let t=document.createElement("button");t.textContent="St%C3%A4ng",t.addEventListener("click",function(){e.parentNode.removeChild(e)}),e.appendChild(t),n.forEach(function(o,r){let a=document.createElement("div");a.innerHTML="<h2>kmom0"+(r+1)+"</h2>",a.innerHTML+=o.body,e.appendChild(a)}),document.body.appendChild(e)}var U={name:"Show all redovisningstexter (not working, need Canvas token)",action:function(){let n=window.location.pathname,e=window.location.search,t=n.split("/")[2],o=/student_id=(\d+)/i,r=e.match(o)[1],a="Bearer [INSERT KEY HERE]",l=`/api/v1/courses/${t}/students/submissions?student_ids[]=${r}`;fetch(l,{headers:{Authorization:a}}).then(function(u){return u.json()}).then(function(u){O(u)}),s.actionRemove()}},B=U;var q={name:"Skriv kommentar",action:function(){if(!document.getElementById("feedbackText")){let n=document.getElementById("speed_grader_comment_textarea")?"speed-franklin.js":"franklin.js";document.body.appendChild(document.createElement("script")).src="https://booklets.emilfolino.se/"+n,new Promise(e=>setTimeout(e,500)).then(()=>{document.getElementById("feedbackText").focus()}),s.actionRemove()}}},T=q;var K={name:"Visa video",action:function(){let n=document.querySelector("#mep_0 .mejs-inner .mejs-mediaelement audio").children[2].src,e=document.querySelector(".ui-dialog.ui-widget.ui-widget-content.ui-corner-all.play_media_comment.ui-draggable"),t=document.createElement("div"),o=document.createElement("div"),r=document.createElement("button");e.remove(),r.innerText="Close",r.addEventListener("click",()=>{t.remove()}),r.style="float:right",t.style="position:absolute;top:50px;left:20px;background-color:#2C3539;color:#fff;padding:10px;",o.innerHTML=`<video controls width="580">
            <source src="${n}" />
        </video> `,t.append(r),t.append(o),document.body.append(t)}},$=K;var v=[_,I,T,S,$,B];async function z(){document.body.appendChild(E);let n=document.getElementById(s.name);i.addEventListener(n,"click",s.manualRemove,i.permanent);let e=document.getElementById(p.name);i.addEventListener(e,"click",function(){i.clearContentListeners(),p.renderHtml(A)},i.permanent),await d.load()}function N(){let n=document.getElementsByClassName("menuItem");for(let e of n)i.addEventListener(e,"click",function(t){v[t.target.id].action()},i.content),e.onmouseover=function(t){t.target.style.cursor="pointer",t.target.style.color="black"},e.onmouseleave=function(t){t.target.style.cursor="pointer",t.target.style.color="white"};i.addEventListener(document,"keydown",function(t){let o=t.code;if(key=String.fromCharCode(o),source=t.target,exclude=["input","textarea"],exclude.indexOf(source.tagName.toLowerCase())===-1){console.log("You pressed "+key+" (keyCode: "+o+").");let r=/Digit(\d+)/i,a=o.match(r);if(a!==null){let l=parseInt(a[1]);l>0&&l<=v.length&&v[l-1].action()}else if(o==="KeyQ")s.manualRemove();else if(o==="KeyS")document.getElementById("comment_submit_button").click();else if(o==="KeyJ"&&t.shiftKey){let l=document.getElementById("submission_to_view");l.options[l.selectedIndex].nextElementSibling.selected="selected",l.dispatchEvent(new Event("change",{bubbles:!0}))}else if(o==="KeyK"&&t.shiftKey){let l=document.getElementById("submission_to_view");l.options[l.selectedIndex].previousElementSibling.selected="selected",l.dispatchEvent(new Event("change",{bubbles:!0}))}}},i.content)}function A(){let n="";v.forEach(function(e,t){n+=`<div id="${t}" class="menuItem">${t+1}) ${e.name}</div>`}),E.childNodes[0].innerHTML=n,N()}document.getElementById("menu")||z().then(()=>{A()});})();
